var ChatRoom={init:function(){if("mobile"!==$.ua.device.type?$(".list").height($(".side").height()-$(".chat-room .module:first").outerHeight()-20):$(".list").height($(window).height()-173),0===$("#chatContent").length)return!1;if("mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor){Util.initCodeMirror();var e=new Editor({element:document.getElementById("chatContent"),dragDrop:!1,lineWrapping:!0,toolbar:[{name:"bold"},{name:"italic"},"|",{name:"quote"},{name:"unordered-list"},{name:"ordered-list"},"|",{name:"link"},{name:"image",html:'<form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="icon-upload"><input type="file"/></label></form>'},"|",{name:"redo"},{name:"undo"},"|",{name:"preview"}],extraKeys:{"Alt-/":"autocompleteUserName","Cmd-/":"autocompleteEmoji","Ctrl-/":"autocompleteEmoji","Alt-S":"startAudioRecord","Alt-R":"endAudioRecord"},status:!1});e.render(),ChatRoom.editor=e.codemirror}else $("#chatContent").before('<form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="btn">'+Label.uploadLabel+'<input type="file"/></label></form>').css("margin",0),ChatRoom.editor=Util.initTextarea("chatContent",function(e){window.localStorage&&(window.localStorage.chatRoom=e.$it.val())});return window.localStorage&&window.localStorage.chatRoom&&""!==window.localStorage.chatRoom.replace(/(^\s*)|(\s*$)/g,"")&&ChatRoom.editor.setValue(window.localStorage.chatRoom),("mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor)&&(ChatRoom.editor.on("changes",function(e){$("#chatContentTip").removeClass("error succ").html(""),window.localStorage&&(window.localStorage.chatRoom=e.getValue());var o=e.getCursor(),t=e.getTokenAt(o);if(0===t.string.indexOf("@"))return e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}),CodeMirror.Pass}),ChatRoom.editor.on("keypress",function(e,o){if(o.ctrlKey&&10===o.charCode)return void ChatRoom.send()}),void ChatRoom.editor.on("keydown",function(e,o){if($.ua.os.name.indexOf("Mac OS")>-1&&o.metaKey&&13===o.keyCode&&ChatRoom.send(),8===o.keyCode){var t=e.getCursor(),a=e.getTokenAt(t),r=CodeMirror.Pos(t.line,t.ch);a=e.getTokenAt(r),/^:\S+:$/.test(a.string)&&e.replaceRange("",CodeMirror.Pos(t.line,a.start),CodeMirror.Pos(t.line,a.end-1))}}))},send:function(){var e=ChatRoom.editor.getValue(),o={content:e};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(o),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3"),ChatRoom.editor.setOption("readOnly","nocursor")},success:function(e,o){e.sc?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue(""),$(".editor-preview").html(""),$(".icon-preview").hasClass("active")&&$(".icon-preview").click(),window.localStorage&&(window.localStorage.chatRoom="")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,o){$(".form button.red").removeAttr("disabled").css("opacity","1"),ChatRoom.editor.setOption("readOnly",!1)}})}};ChatRoom.init();